# Copilot Context â€” PayTread

This file contains non-negotiable architecture, security, and implementation rules for Copilot suggestions and any automated code generation for the PayTread project. Additions to the repository should follow these constraints.

## Non-negotiable payments rails
- PayTread uses Priority Payments rails for all payment processing and payouts.
- Do not generate Stripe, Dwolla, PayPal, Square, or other payment provider code.

## Architecture rule
- All payment operations MUST go through `lib/payments/priority/*`.
- No direct HTTP calls to a payments API should be scattered in routes/components.

## Key objects
- Load: freight load being paid
- POD: proof of delivery
- Payout: money movement to carrier
- LedgerEntry: immutable accounting record tied to load + payout

## Terminology
- "Priority Payments" = the processor/rails
- "Payout" = disbursement to carrier (push-to-debit/RTP/ACH depending on Priority capabilities)
- "Funding source" = broker/shipper funding method maintained in Priority

## Implementation rules
- Use provider interface `PaymentsProvider` from `lib/payments/types.ts`.
- Only implementation: `PriorityPaymentsProvider` (under `lib/payments/priority/`).
- Webhooks are handled ONLY in `app/api/webhooks/priority/route.ts`.
- Never store raw sensitive card/bank details in PayTread DB. Store tokens/IDs returned by Priority instead.

## Security
- Never log full PAN/bank account numbers.
- Store only last4 + tokens/IDs returned by Priority.

## Developer guidance
- When adding or modifying payment code, add/update unit tests under `tests/` that validate:
  - All payment interactions go through the `PaymentsProvider` interface.
  - No raw PAN/account numbers are written to DB or logs.
- If a new payment capability is required, add it to `lib/payments/types.ts` and implement in `lib/payments/priority/`.

---

Addendum: If a temporary sandbox/mock adapter is needed for local dev, implement it under `lib/payments/priority/sandbox.ts` and ensure the real `PriorityPaymentsProvider` is the only production provider wired in server configuration.
